(function(e){acf.fields.repeater={$field:null,$el:null,o:{},set:function(t){e.extend(this,t);this.$field=this.$el.closest(".acf-field");this.o=acf.helpers.get_atts(this.$el);this.o.row_count=this.$el.find("> table > tbody > tr").length-1;return this},init:function(){var e=this,t=this.$el;this.o.max!=1&&this.$el.find("> table > tbody").unbind("sortable").sortable({items:"> tr",handle:"> td.order",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){acf.trigger("sortstart",[t.item,t.placeholder])},stop:function(n,r){acf.trigger("sortstop",[r.item,r.placeholder]);e.set({$el:t}).render()}});this.render()},render:function(){this.$el.find("> table > tbody > tr").each(function(t){e(this).children("td.order").html(t+1)});this.o.row_count==0?this.$el.addClass("empty"):this.$el.removeClass("empty");if(this.o.row_count>=this.o.max_rows){this.$el.addClass("disabled");this.$el.find("> .acf-hl .acf-button").addClass("disabled")}else{this.$el.removeClass("disabled");this.$el.find("> .acf-hl .acf-button").removeClass("disabled")}},add:function(t){if(this.o.row_count>=this.o.max_rows){alert(acf._e("repeater","max").replace("{max}",this.o.max_rows));return!1}var n=acf.helpers.uniqid(),r=this.$el.find('> table > tbody > tr[data-id="acfcloneindex"]').html().replace(/(=["]*[\w-\[\]]*?)(acfcloneindex)/g,"$1"+n),i=e('<tr class="acf-row" data-id="'+n+'"></tr>').append(r);t||(t=this.$el.find('> table > tbody > tr[data-id="acfcloneindex"]'));t.before(i);this.$el.parents("tr").trigger("mouseenter");this.render();acf.trigger("append",[i]);this.$field.removeClass("error")},remove:function(e){var t=this;if(this.o.row_count<=this.o.min_rows){alert(acf._e("repeater","min").replace("{min}",this.o.min_rows));return!1}acf.helpers.remove_tr(e,function(){t.$el.closest("tr").trigger("mouseenter");t.render()})}};acf.on("ready append",function(t,n){n.find(".acf-repeater").each(function(){acf.fields.repeater.set({$el:e(this)}).init()})});e(document).on("click",".acf-repeater .acf-repeater-add-row",function(t){t.preventDefault();var n=!1;e(this).attr("data-before")&&(n=e(this).closest(".acf-row"));acf.fields.repeater.set({$el:e(this).closest(".acf-repeater")}).add(n);e(this).blur()});e(document).on("click",".acf-repeater .acf-repeater-remove-row",function(t){t.preventDefault();acf.fields.repeater.set({$el:e(this).closest(".acf-repeater")}).remove(e(this).closest(".acf-row"));e(this).blur()});e(document).on("mouseenter",".acf-repeater tr.acf-row",function(t){var n=e(this).find("> td.remove .acf-repeater-add-row"),r=n.parent().height()/2+9;n.css("margin-top","-"+r+"px")});acf.fields.flexible_content={$el:null,$values:null,o:{},set:function(t){e.extend(this,t);this.$values=this.$el.children(".values");this.o=acf.helpers.get_atts(this.$el);this.o.layout_count=this.$values.children(".layout").length;return this},init:function(){var t=this,n=this.$el;this.o.max!=1&&this.$values.unbind("sortable").sortable({items:"> .layout",handle:"> .acf-fc-layout-handle",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){acf.trigger("sortstart",[t.item,t.placeholder])},stop:function(e,r){acf.trigger("sortstop",[r.item,r.placeholder]);t.set({$el:n}).render()}});this.render();var r=!1;if(this.o.min>0)r=!0;else{var i=e(this.$el.children(".tmpl-popup").html());i.find("a").each(function(){var t=parseInt(e(this).attr("data-min"));if(t>0){r=!0;return!1}})}r&&this.$el.closest(".field").addClass("required")},render:function(){this.$values.children(".layout").each(function(t){e(this).find("> .acf-fc-layout-handle .fc-layout-order").html(t+1)});this.o.layout_count==0?this.$el.addClass("empty"):this.$el.removeClass("empty");if(this.o.layout_count>=this.o.max){this.$el.addClass("disabled");this.$el.find("> .acf-hl .acf-button").addClass("disabled")}else{this.$el.removeClass("disabled");this.$el.find("> .acf-hl .acf-button").removeClass("disabled")}},validate_add:function(t){var n=!0;this.o.max=parseInt(this.o.max);if(this.o.max>0&&this.o.layout_count>=this.o.max){var r=this.o.max==1?"layout":"layouts",i=acf.l10n.flexible_content.max;i=i.replace("{max}",this.o.max);i=i.replace("{identifier}",acf.l10n.flexible_content[r]);n=!1;alert(i)}var s=e(this.$el.children(".tmpl-popup").html()),o=s.find('[data-layout="'+t+'"]'),u=o.attr("data-max"),a=this.$values.children('.layout[data-layout="'+t+'"]').length;u=parseInt(u);if(u>0&&a>=u){var r=u==1?"layout":"layouts",i=acf.l10n.flexible_content.max_layout;i=i.replace("{max}",a);i=i.replace("{label}",'"'+o.text()+'"');i=i.replace("{identifier}",acf.l10n.flexible_content[r]);n=!1;alert(i)}return n},validate_remove:function(t){this.o.min=parseInt(this.o.min);if(this.o.min>0&&this.o.layout_count<=this.o.min){var n=this.o.min==1?"layout":"layouts",r=acf.l10n.flexible_content.min+", "+acf.l10n.flexible_content.remove;r=r.replace("{min}",this.o.min);r=r.replace("{identifier}",acf.l10n.flexible_content[n]);r=r.replace("{layout}",acf.l10n.flexible_content.layout);return confirm(r)}var i=e(this.$el.children(".tmpl-popup").html()),s=i.find('[data-layout="'+t+'"]'),o=s.attr("data-min"),u=this.$values.children('.layout[data-layout="'+t+'"]').length;o=parseInt(o);if(o>0&&u<=o){var n=o==1?"layout":"layouts",r=acf.l10n.flexible_content.min_layout+", "+acf.l10n.flexible_content.remove;r=r.replace("{min}",u);r=r.replace("{label}",'"'+s.text()+'"');r=r.replace("{identifier}",acf.l10n.flexible_content[n]);r=r.replace("{layout}",acf.l10n.flexible_content.layout);return confirm(r)}return!0},add:function(t,n){if(!this.validate_add(t))return;var r=acf.helpers.uniqid(),i=this.$el.find('> .clones > .layout[data-layout="'+t+'"]').html().replace(/(=["]*[\w-\[\]]*?)(acfcloneindex)/g,"$1"+r),s=e('<div class="layout" data-layout="'+t+'"></div>').append(i);this.$el.children(".no-value-message").hide();n?n.before(s):this.$values.append(s);e(document).trigger("acf/setup_fields",[s]);this.render();this.$el.closest(".field").removeClass("error")},remove:function(t){if(!this.validate_remove(t.attr("data-layout")))return;var n=this;t.css({height:t.height(),width:t.width(),position:"absolute"});t.animate({opacity:0},250,function(){e(this).remove()});$blank=e('<div style="height:'+t.height()+'px"></div>');t.after($blank);var r=0;t.siblings(".layout").length==0&&(r=this.$el.children(".no-value-message").outerHeight());$blank.animate({height:r},250,function(){e(this).remove();r>0&&n.$el.children(".no-value-message").show()})},toggle:function(e){if(e.attr("data-toggle")=="closed"){e.attr("data-toggle","open");e.children(".acf-input-table").show()}else{e.attr("data-toggle","closed");e.children(".acf-input-table").hide()}},open_popup:function(t,n){var r=this;n=n||!1;$popup=e(this.$el.children(".tmpl-popup").html());$popup.find("a").each(function(){var t=parseInt(e(this).attr("data-min")),n=parseInt(e(this).attr("data-max")),i=e(this).attr("data-layout"),s=e(this).text(),o=r.$values.children('.layout[data-layout="'+i+'"]').length,u=e(this).children(".status");if(n>0){var a=n-o,f=acf.l10n.flexible_content.available,l=a==1?"layout":"layouts",f=f.replace("{available}",a);f=f.replace("{max}",n);f=f.replace("{label}",'"'+s+'"');f=f.replace("{identifier}",acf.l10n.flexible_content[l]);u.show().text(a).attr("title",f);a==0&&u.addClass("warning")}if(t>0){var c=t-o,f=acf.l10n.flexible_content.required,l=c==1?"layout":"layouts",f=f.replace("{required}",c);f=f.replace("{min}",t);f=f.replace("{label}",'"'+s+'"');f=f.replace("{identifier}",acf.l10n.flexible_content[l]);c>0&&u.addClass("warning").show().text(c).attr("title",f)}});t.after($popup);if(n){$popup.addClass("within-layout");$popup.closest(".layout").addClass("popup-open")}$popup.css({"margin-top":0-$popup.height()-t.outerHeight()-14,"margin-left":(t.outerWidth()-$popup.width())/2});var i=$popup.offset().top;if(i<30){$popup.css({"margin-top":15});$popup.find(".bit").addClass("top")}$popup.children(".focus").trigger("focus")}};acf.on("ready append",function(t,n){n.find(".acf-flexible-content").each(function(){acf.fields.flexible_content.set({$el:e(this)}).init()})});e(document).on("click",".acf-flexible-content .acf-fc-add",function(t){t.preventDefault();var n=!1;e(this).attr("data-before")&&(n=!0);acf.fields.flexible_content.set({$el:e(this).closest(".acf-flexible-content")}).open_popup(e(this),n);e(this).blur()});e(document).on("click",".acf-flexible-content .acf-fc-remove",function(t){t.preventDefault();acf.fields.flexible_content.set({$el:e(this).closest(".acf-flexible-content")}).remove(e(this).closest(".layout"));e(this).blur()});e(document).on("click",".acf-flexible-content .acf-fc-layout-handle",function(t){t.preventDefault();acf.fields.flexible_content.toggle(e(this).closest(".layout"));e(this).blur()});e(document).on("click",".acf-flexible-content .acf-fc-popup li a",function(t){t.preventDefault();var n=e(this).closest(".acf-fc-popup"),r=null;n.hasClass("within-layout")&&(r=n.closest(".layout"));acf.fields.flexible_content.set({$el:e(this).closest(".acf-flexible-content")}).add(e(this).attr("data-layout"),r);e(this).blur()});e(document).on("blur",".acf-flexible-content .acf-fc-popup .focus",function(t){var n=e(this).parent();n.closest(".layout").exists()&&n.closest(".layout").removeClass("popup-open");setTimeout(function(){n.remove()},200)});e(document).on("acf/validate_field",function(t,n){var r=e(n);if(!r.hasClass("field_type-flexible_content"))return;var i=r.find(".acf-flexible-content:first");r.data("validation",!1);r.data("validation_message",!1);i.children(".values").children(".layout").exists()&&r.data("validation",!0);var s=parseInt(i.attr("data-min"));if(s>0&&i.children(".values").children(".layout").length<s){var o=s==1?"layout":"layouts",u=acf.l10n.flexible_content.min;u=u.replace("{min}",s);u=u.replace("{identifier}",acf.l10n.flexible_content[o]);r.data("validation",!1);r.data("validation_message",u)}var a=e(i.children(".tmpl-popup").html());a.find("a").each(function(){var t=parseInt(e(this).attr("data-min")),n=parseInt(e(this).attr("data-max")),s=e(this).attr("data-layout"),o=e(this).text(),u=i.children(".values").children('.layout[data-layout="'+s+'"]').length;if(u<t){var a=t==1?"layout":"layouts",f=acf.l10n.flexible_content.min_layout;f=f.replace("{min}",t);f=f.replace("{label}",'"'+o+'"');f=f.replace("{identifier}",acf.l10n.flexible_content[a]);r.data("validation",!1);r.data("validation_message",f)}})})})(jQuery);